<div class="form-row" [formGroup]="questionaryControlService.mainForm">

  <div #defaultQuestion class="form-element-wrapper radio-button-wrapper" [formGroupName]="'defaultQuestionaryGroup'"
       *ngIf="questionaryControlService.currentQuestionIndex == questionaryControlService.questionaryLength">
    <h2 class="question-title">When do you need your project started?</h2>
    <div class="radio-button-group fill-flex-space">

      <cv-radio-group formControlName="startExpectation" required>
        <cv-radio *ngFor="let option of startExpectationOptions" [value]="option" [checked]="defaultQuestionaryForm.get('startExpectation').value == option">{{option}}</cv-radio>
      </cv-radio-group>

      <div class="question-general-error"
           *ngIf="defaultQuestionaryForm.get('startExpectation').dirty || defaultQuestionaryForm.get('startExpectation').touched">
          <span class="mat-error"
                *ngIf="defaultQuestionaryForm.get('startExpectation').errors?.required">Is required</span>
      </div>

    </div>

    <div class="questionary-dialog-footer">
      <button cv-button-empty class="questionary-previous-button" (click)="questionaryControlService.previousQuestion()" *ngIf="!questionaryControlService.withZip || questionaryControlService.trade || questionaryControlService.currentQuestionIndex >= 1" type="button">Back</button>
      <button cv-button class="questionary-next-button" (click)="nextQuestion('startExpectation')" type="button">Next</button>
    </div>

  </div>

  <div #defaultQuestion class="form-element-wrapper radio-button-wrapper" [formGroupName]="'defaultQuestionaryGroup'"
       *ngIf="questionaryControlService.currentQuestionIndex == questionaryControlService.questionaryLength + 1">
    <h2 class="question-title" *ngIf="questionaryControlService.questionaryLength == 0">Please provide some project
      details for Professional</h2>
    <h2 class="question-title" *ngIf="questionaryControlService.questionaryLength != 0">Anything else Professional
      should know about your project</h2>
    <div class="text-input-group fill-flex-space">
      <cv-input-field>
        <cv-field-label>Project details</cv-field-label>
        <textarea cv-input
                  placeholder="Describe your project for professional"
                  formControlName="notes"
                  [cv_trim]="defaultQuestionaryForm.get('notes').value"
                  (cv_trimChange)="defaultQuestionaryForm.get('notes').setValue($event)"
                  rows="4"
                  type="text"
                  [minlength]="questionaryControlService.questionaryLength == 0 ? constants.PROJECT_DESCRIPTION_MIN_LENGTH : undefined"
                  maxlength="1500"
                  [required]="questionaryControlService.questionaryLength == 0 ? 'required' : undefined"></textarea>
        <cv-field-hint>{{defaultQuestionaryForm.get('notes').value.length}}/1500</cv-field-hint>
        <cv-field-error
          *ngIf="defaultQuestionaryForm.get('notes').dirty || defaultQuestionaryForm.get('notes').touched ">
          <span *ngIf="defaultQuestionaryForm.get('notes').errors?.required">Required</span>
          <span *ngIf="defaultQuestionaryForm.get('notes').errors?.minlength">{{constants.PROJECT_DESCRIPTION_MIN_LENGTH}} characters minimum</span>
        </cv-field-error>
      </cv-input-field>
    </div>

    <div class="questionary-dialog-footer">
      <button cv-button-empty class="questionary-previous-button" (click)="questionaryControlService.previousQuestion()" type="button">Back</button>
      <button cv-button class="questionary-next-button" (click)="nextQuestion('notes')" type="button">Next</button>
    </div>

  </div>

  <div #defaultQuestion class="form-element-wrapper text-input-wrapper" [formGroupName]="'defaultQuestionaryGroup'"
       *ngIf="(securityService.hasRole(Role.ANONYMOUS) || personalInfoRequired()) && (questionaryControlService.currentQuestionIndex == questionaryControlService.questionaryLength + 2)">
    <h2 class="question-title" *ngIf="securityService.hasRole(Role.ANONYMOUS) && !waitingPhoneConfirmation">Let's get acquainted</h2>
    <h2 class="question-title" *ngIf="waitingPhoneConfirmation">Verify your phone</h2>
    <h2 class="question-title" *ngIf="securityService.hasRole(Role.CUSTOMER) && !questionaryControlService.customerAccountIsLoading && !waitingPhoneConfirmation">Please add your phone number</h2>

    <div class="text-input-group fill-flex-space" [formGroupName]="'customerPersonalInfo'" [cvSpinner]="registrationProcessing" [cvSpinnerSize]="50" [cvSpinnerBackground]="true">

      <div class="auth-block" *ngIf="!emailIsChecked && securityService.hasRole(Role.ANONYMOUS)">

        <div class="auth-social-title">
          <span>Make it quickly with your social network</span>
        </div>

        <social-buttons [inQuestionary]="true"></social-buttons>

        <div class="email-auth-hint" *ngIf="securityService.hasRole(Role.ANONYMOUS)">
          <span>or continue with Email</span>
        </div>

      </div>

      <cv-input-field *ngIf="securityService.hasRole(Role.ANONYMOUS) && !waitingPhoneConfirmation">
        <cv-field-label>Email</cv-field-label>
        <input cv-input
               (blur)="deviceControlService.isIOS() && submitUserInfo()"
               (keypress)="deviceControlService.isAndroid($event) && submitUserInfo()"
               type="text"
               inputmode="email"
               placeholder="Email"
               formControlName="email"
               name="email"
               required
               trim
               [pattern]="constants.patterns.email"
               [disabled]="emailIsChecked">
        <cv-field-error
          *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.email').dirty || defaultQuestionaryForm.get('customerPersonalInfo.email').touched">
          <span *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.email').errors?.required">{{messages.errors.email.required}}</span>
          <span
            *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.email').errors?.pattern">{{messages.errors.email.pattern}}</span>
        </cv-field-error>
      </cv-input-field>

      <cv-input-field *ngIf="securityService.hasRole(Role.ANONYMOUS) && emailIsChecked && !emailIsUnique">
        <cv-field-label>Password</cv-field-label>
        <input cv-input
               (blur)="deviceControlService.isIOS() && submitUserInfo()"
               (keypress)="deviceControlService.isAndroid($event) && submitUserInfo()"
               type="password"
               placeholder="Password"
               name="password"
               formControlName="password"
               (ngModelChange)="resetCaptcha()"
               required>
      </cv-input-field>

      <div class="captcha-reminder" *ngIf="securityService.hasRole(Role.ANONYMOUS) && emailIsChecked && !emailIsUnique">This site is protected by reCAPTCHA and the Google
        <a href="https://policies.google.com/privacy">Privacy Policy</a> and
        <a href="https://policies.google.com/terms">Terms of Service</a> apply.
      </div>

      <response-message *ngIf="showLoginMessage && emailIsChecked" [type]="loginMessageType" [message]="loginMessageText"
                        [paddingV]="12" [paddingH]="24"
                        marginTop="0"
                        [showIcon]="false" (onHide)="onLoginMessageHide($event)"></response-message>

      <div class="personal-data-info" *ngIf="!waitingPhoneConfirmation && (emailIsChecked && emailIsUnique || securityService.isAuthenticated()) && !questionaryControlService.customerAccountIsLoading && personalInfoRequired() ">

        <cv-input-field *ngIf="securityService.hasRole(Role.ANONYMOUS)">
          <cv-field-label>First name</cv-field-label>
          <input cv-input type="text"
                 placeholder="First name"
                 formControlName="firstName"
                 name="firstName"
                 trim
                 minlength="2"
                 [pattern]="constants.patterns.name"
                 required>
          <cv-field-error
            *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.firstName').dirty || defaultQuestionaryForm.get('customerPersonalInfo.firstName').touched">
            <span *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.firstName').errors?.required">{{messages.errors.firstName.required}}</span>
            <span *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.firstName').errors?.minlength">{{messages.errors.firstName.minlength}}</span>
            <span *ngIf="!defaultQuestionaryForm.get('customerPersonalInfo.firstName').errors?.minlength && defaultQuestionaryForm.get('customerPersonalInfo.firstName').errors?.pattern">{{messages.errors.name.notValid}}</span>
          </cv-field-error>
        </cv-input-field>

        <cv-input-field *ngIf="securityService.hasRole(Role.ANONYMOUS)">
          <cv-field-label>Last name</cv-field-label>
          <input cv-input type="text"
                 placeholder="Last name"
                 formControlName="lastName"
                 name="lastName"
                 trim
                 minlength="2"
                 [pattern]="constants.patterns.name"
                 required>
          <cv-field-error
            *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.lastName').dirty || defaultQuestionaryForm.get('customerPersonalInfo.lastName').touched">
            <span *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.lastName').errors?.required">{{messages.errors.lastName.required}}</span>
            <span *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.lastName').errors?.minlength">{{messages.errors.lastName.minlength}}</span>
            <span *ngIf="!defaultQuestionaryForm.get('customerPersonalInfo.lastName').errors?.minlength && defaultQuestionaryForm.get('customerPersonalInfo.lastName').errors?.pattern">{{messages.errors.name.notValid}}</span>
          </cv-field-error>
        </cv-input-field>

        <cv-input-field *ngIf="!questionaryControlService.customerHasPhone" [cvSpinner]="questionaryControlService.customerAccountIsLoading"
                        [cvSpinnerSize]="20" [cvSpinnerBackground]="true">
          <cv-field-label>Phone number</cv-field-label>
          <input cv-input
                 type="text"
                 inputmode="tel"
                 placeholder="Phone number"
                 (blur)="deviceControlService.isIOS() && submitUserInfo()"
                 (keypress)="deviceControlService.isAndroid($event) && submitUserInfo()"
                 formControlName="phone"
                 name="phone"
                 phoneMask
                 maxlength="14"
                 [pattern]="constants.patterns.phone"
                 required>
          <cv-field-error
            *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.phone').dirty || defaultQuestionaryForm.get('customerPersonalInfo.phone').touched">
            <span *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.phone').errors?.required">{{messages.errors.phone.required}}</span>
            <span *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.phone').errors?.pattern">{{messages.errors.phone.pattern}}</span>
            <span *ngIf="defaultQuestionaryForm.get('customerPersonalInfo.phone').errors?.allZeros">{{messages.errors.phone.pattern}}</span>
          </cv-field-error>
        </cv-input-field>

        <div class="terms-line" *ngIf="!securityService.isAuthenticated()">By proceeding you are accepting our <a target="_blank" href="/terms-of-use">Terms of Use</a> and <a
          target="_blank" href="/privacy-policy">Privacy Policy</a></div>

      </div>

      <phone-validation *ngIf="waitingPhoneConfirmation" [showEditButton]="true" [phoneNumber]="defaultQuestionaryForm.get('customerPersonalInfo.phone').value" (onSuccess)="onPhoneValidated()" (onPhoneNumberChangeClick)="editPhoneAgain()"></phone-validation>

    </div>

    <re-captcha #captchaRef *ngIf="securityService.captchaEnabled && securityService.hasRole(Role.ANONYMOUS)" [size]="'invisible'" (resolved)="resolveCaptcha($event)"></re-captcha>

    <div class="questionary-dialog-footer" *ngIf="!registrationProcessing" [cvSpinner]="emailIsChecking || loginProcessing || registrationProcessing || questionaryControlService.customerAccountIsLoading" [cvSpinnerSize]="20" [cvSpinnerBackground]="true">

      <button cv-button-empty class="questionary-previous-button" *ngIf="!emailIsChecked && !waitingPhoneConfirmation" (click)="questionaryControlService.previousQuestion();" type="button" [disabled]="questionaryControlService.customerAccountIsLoading">Back</button>

      <button cv-button-empty class="questionary-previous-button" *ngIf="emailIsChecked && !waitingPhoneConfirmation" (click)="emailIsChecked = false; emailIsUnique = undefined; showLoginMessage = false; editPhoneAgain(); resetCaptcha()" type="button" [disabled]="questionaryControlService.customerAccountIsLoading" >Back</button>

      <button *ngIf="securityService.hasRole(Role.ANONYMOUS) && !emailIsChecked"
              cv-button class="questionary-next-button"
              (click)="checkEmail(defaultQuestionaryForm.get('customerPersonalInfo.email').value)"
              type="button" [disabled]="disabledNextAction">
        Next
      </button>

      <button *ngIf="securityService.hasRole(Role.ANONYMOUS) && emailIsChecked && !emailIsUnique"
              cv-button class="questionary-next-button"
              (click)="captchaValidation()" type="button" [disabled]="disabledNextAction">
        Next
      </button>

      <button *ngIf="(securityService.hasRole(Role.CUSTOMER) || emailIsChecked && emailIsUnique) && personalInfoRequired()"
              cv-button class="questionary-next-button"
              (click)="nextQuestion('customerPersonalInfo', !questionaryControlService.customerHasPhone && !phoneValid ? validatePhone : undefined)" type="button" [disabled]="disabledNextAction">
        Next
      </button>

    </div>

  </div>

  <div #defaultQuestion class="form-element-wrapper text-input-wrapper"
        [formGroupName]="'defaultQuestionaryGroup'"
       *ngIf="questionaryControlService.currentQuestionIndex == questionaryControlService.questionaryLength + 2 + (personalInfoRequired() ? 1 : 0)">
    <h2 class="question-title">Where do you need a Professional?</h2>
    <div class="text-input-group fill-flex-space" [formGroupName]="'projectLocation'"
         [cvSpinner]="processingAddressValidation"
         [cvSpinnerSize]="50"
         [cvSpinnerBackground]="true">
      <cv-input-field>
        <cv-field-label>Address</cv-field-label>
        <input cv-input type="text"
               name="streetAddress"
               placeholder="Address"
               [formControlName]="'streetAddress'"
               [id]="'streetAddress'"
               required>
        <cv-field-error
          *ngIf="defaultQuestionaryForm.get('projectLocation.streetAddress').dirty || defaultQuestionaryForm.get('projectLocation.streetAddress').touched">
            <span
              *ngIf="defaultQuestionaryForm.get('projectLocation.streetAddress').errors?.required">Is required</span>
        </cv-field-error>
      </cv-input-field>
      <cv-input-field>
        <cv-field-label>City</cv-field-label>
        <input type="text"
               cv-input
               name="city"
               placeholder="City"
               [id]="'city'"
               [formControlName]="'city'"
               required>
        <cv-field-error
          *ngIf="defaultQuestionaryForm.get('projectLocation.city').dirty || defaultQuestionaryForm.get('projectLocation.city').touched">
          <span *ngIf="defaultQuestionaryForm.get('projectLocation.city').errors?.required">Is required</span>
        </cv-field-error>
      </cv-input-field>
      <cv-input-field>
        <cv-field-label>State</cv-field-label>
        <cv-select [multiple]="false" [tags]="false" [autocomplete]="true"
                   (autocompleteSearch)="autocompleteStateSearch($event)" [items]="filteredStates"
                   [disableItemsMatch]="true"
                   valueKey="value"
                   labelKey="value"
                   name="state"
                   [formControlName]="'state'"
                   [id]="'state'"
                   required
                   label="Choose state">
        </cv-select>
        <cv-field-error
          *ngIf="defaultQuestionaryForm.get('projectLocation.state').dirty || defaultQuestionaryForm.get('projectLocation.state').touched">
          <span *ngIf="defaultQuestionaryForm.get('projectLocation.state').errors?.required">Is required</span>
        </cv-field-error>
      </cv-input-field>
      <cv-input-field>
        <cv-field-label>Zip</cv-field-label>
        <input cv-input
               type="text"
               (blur)="deviceControlService.isIOS() && nextQuestion('projectLocation', validateLocation)"
               (keypress)="deviceControlService.isAndroid($event) && nextQuestion('projectLocation', validateLocation)"
               inputmode="numeric"
               placeholder="Zip"
               name="zip"
               maxlength="5"
               [formControlName]="'zip'"
               numericMask
               pattern="{{constants.patterns.zipcode}}"
               required>
        <cv-field-error
          *ngIf="defaultQuestionaryForm.get('projectLocation.zip').dirty || defaultQuestionaryForm.get('projectLocation.zip').touched">
          <span *ngIf="defaultQuestionaryForm.get('projectLocation.zip').errors?.required">Is required</span>
          <span
            *ngIf="defaultQuestionaryForm.get('projectLocation.zip').errors?.pattern">{{messages.errors.zip.pattern}}</span>
        </cv-field-error>
      </cv-input-field>
      <cv-field-error class="location-error">{{locationValidation | lowercase}}</cv-field-error>
      <div class="address-validation" [ngClass]="{'-invalid': locationInvalid}">
        <div class="row">
          <div class="col-xs-12 col-sm-6">
            <div class="address">
              <h4>You entered</h4>
              <p>
                {{originalAddress?.streetAddress}}<br>
                {{originalAddress?.city}},
                {{originalAddress?.state}}
                {{originalAddress?.zip}}
              </p>
            </div>
            <button cv-button-empty type="button" (click)="resetLocationQuestion()">Use another address</button>
          </div>
          <div class="col-xs-12 col-sm-6">
            <div class="address apply" (click)="chooseAddress(suggestedAddress)">
              <div class="overlay"><i></i></div>
              <h4>Suggested address</h4>
              <p>
                {{suggestedAddress?.streetAddress}}<br>
                {{suggestedAddress?.city}},
                {{suggestedAddress?.state}}
                {{suggestedAddress?.zip}}
              </p>
            </div>
            <button cv-button type="button" (click)="chooseAddress(suggestedAddress)">Use suggested</button>
          </div>
        </div>
        <span *ngIf="validationMessage">{{validationMessage}}</span>
      </div>
    </div>

    <div class="questionary-dialog-footer" [cvSpinner]="postOrderProcessing"
         [cvSpinnerSize]="20">
      <button cv-button-empty class="questionary-previous-button" (click)="questionaryControlService.previousQuestion()" type="button"
              *ngIf="!hideNextAction && !postOrderProcessing">Back
      </button>
      <button *ngIf="!hideNextAction"
              cv-button class="questionary-next-button"
              (click)="nextQuestion('projectLocation', validateLocation)" type="button"
              [disabled]="disabledNextAction">
        Next
      </button>
    </div>
  </div>

  <div #defaultQuestion class="form-element-wrapper text-input-wrapper" [formGroupName]="'defaultQuestionaryGroup'"
       *ngIf="questionaryControlService.currentQuestionIndex == questionaryControlService.questionaryLength + 3 + (personalInfoRequired() ? 1 : 0)">
    <h2 class="question-title">Let's check your <b>{{questionaryControlService.serviceType.name}}</b> request</h2>

    <div class="project-summary fill-flex-space">
        <div class="project-details-group" *ngIf="!securityService.isAuthenticated()">
          <div class="label">Phone:</div>
          <div class="value main">{{defaultQuestionaryForm.get('customerPersonalInfo.phone').value}}</div>
        </div>
        <div class="project-details-group">
          <div class="label">Location:</div>
          <div class="value main">
            {{defaultQuestionaryForm.get('projectLocation').value?.streetAddress}},
            {{defaultQuestionaryForm.get('projectLocation').value?.city}},
            {{defaultQuestionaryForm.get('projectLocation').value?.state}}
            {{defaultQuestionaryForm.get('projectLocation').value?.zip}}
          </div>
        </div>
        <div class="project-details-group">
          <div class="label">When do you need your project started:</div>
          <div class="value main">{{defaultQuestionaryForm.get('startExpectation').value}}</div>
        </div>

        <div class="project-details-group">
          <div class="label">Notes:</div>
          <div class="value main">{{defaultQuestionaryForm.get('notes').value}}</div>
        </div>
        <ng-template ngFor let-question [ngForOf]="questionaryAnswers">
          <div class="project-details-group">
            <div class="label">{{question.key}}:</div>
            <div class="value">
              <ng-template ngFor let-value [ngForOf]="question.value">
                <span>{{value}}</span>
              </ng-template>
            </div>
          </div>
        </ng-template>
      </div>

    <div class="questionary-dialog-footer" fxLayoutAlign="end center">
      <button cv-button-empty class="questionary-previous-button" (click)="questionaryControlService.previousQuestion()" type="button">Back</button>
      <div fxFlex=""></div>
      <button cv-button class="questionary-next-button" (click)="onSubmit()" type="button" [loading]="postOrderProcessing">Confirm</button>
    </div>

</div>

</div>
