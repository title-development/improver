<div class="panel-header">
  <h1>Unassigned Tickets</h1>
  <p-button (onClick)="refresh()" icon="pi pi-fw pi-refresh" label="&nbsp;&nbsp;Refresh"></p-button>
</div>

<p-dataTable class="tickets-table" [lazy]="true" [loading]="processing" #dt
             [value]="tickets.content"
             selectionMode="single" sortMode="single"
             [responsive]="true" [contextMenu]="cm" [paginator]="true"
             [rows]="rowsPerPage[0]" [totalRecords]="tickets.totalElements" [rowsPerPageOptions]="rowsPerPage"
             sortField="created" [sortOrder]="-1"
             (onContextMenuSelect)="selectItem($event)"
             (onLazyLoad)="loadLazy($event)" [expandableRows]="true" (onRowSelect)="expandRow($event)">
  <p-header>
    <div style="text-align:left">
      <p-multiSelect [options]="tableColumns" [panelStyle]="{minWidth:'270px'}" [(ngModel)]="selectedTableCols"></p-multiSelect>
    </div>
  </p-header>
  <p-column field="id" header="ID" [sortable]="true" *ngIf="selectedTableCols.includes('id')" [filter]="true" [style]="{'width':'80px'}"></p-column>
  <p-column field="created" header="Created" [sortable]="true" *ngIf="selectedTableCols.includes('created')">
    <ng-template let-col let-data="rowData" pTemplate="body">
      {{data[col.field] | date: 'MMM d, y, h:mm a'}}
    </ng-template>
  </p-column>
  <p-column field="updated" header="Updated" [sortable]="true" *ngIf="selectedTableCols.includes('updated')">
    <ng-template let-col let-data="rowData" pTemplate="body">
      {{data[col.field] | date: 'MMM d, y, h:mm a'}}
    </ng-template>
  </p-column>
  <p-column field="email" header="Email" filterField="email" sortField="email"  [sortable]="true" *ngIf="selectedTableCols.includes('email')" [filter]="true"></p-column>
  <p-column field="name" header="Name" filterField="name" sortField="name"  [sortable]="true" *ngIf="selectedTableCols.includes('name')" [filter]="true"></p-column>
  <p-column field="businessName" header="Business name" filterField="businessName" sortField="businessName"  [sortable]="true" *ngIf="selectedTableCols.includes('businessName')" [filter]="true"></p-column>
  <p-column field="description" header="Description" filterField="description" [sortable]="false" *ngIf="selectedTableCols.includes('description')"></p-column>
  <p-column field="subject" header="Subject" [sortable]="true" [filter]="true"
            *ngIf="selectedTableCols.includes('subject')">
    <ng-template pTemplate="filter" let-col>
      <p-dropdown [options]="ticketSubjectFilter" [style]="{'width':'100%'}"
                  (onChange)="dt.filter($event.value,col.field,col.filterMatchMode)"
                  styleClass="ui-column-filter"></p-dropdown>
    </ng-template>
    <ng-template let-col let-row="rowData" pTemplate="body">
      <div *ngIf="row.option">{{row.option}}</div>
    </ng-template>
  </p-column>
  <p-column field="status" header="Status" *ngIf="selectedTableCols.includes('status')"></p-column>
  <p-column field="priority" header="Priority" [sortable]="true" [filter]="true"
            *ngIf="selectedTableCols.includes('priority')">
    <ng-template pTemplate="filter" let-col>
      <p-dropdown [options]="ticketPriorityFilter" [style]="{'width':'100%'}"
                  (onChange)="dt.filter($event.value,col.field,col.filterMatchMode)"
                  styleClass="ui-column-filter"></p-dropdown>
    </ng-template>
    <ng-template let-col let-row="rowData" pTemplate="body">
      <div *ngIf="row.priority">{{row.priority}}</div>
    </ng-template>
  </p-column>
  <p-column field="authorName" header="Author" filterField="author" sortField="author" [sortable]="false" *ngIf="selectedTableCols.includes('authorEmail')" [filter]="true">
    <ng-template let-col let-row="rowData" pTemplate="body">
      <div *ngIf="row.authorEmail">{{row.authorEmail + ' <' + row.authorRole + '>'}}</div>
    </ng-template>
  </p-column>

  <ng-template let-data pTemplate="rowexpansion">
    <div class="ui-grid ui-grid-responsive ui-fluid">
      <div class="ui-grid-row">
        <div class="ui-grid-col-9">
          <div class="ui-grid ui-grid-responsive ui-grid-pad" style="text-align: left">
            {{data.description}}
          </div>
        </div>
      </div>
    </div>
  </ng-template>

</p-dataTable>

<ticket-edit-dialog [ticket]="selected" [(display)]="displayTicketDialog" (onDone)="refresh()"></ticket-edit-dialog>

<p-contextMenu #cm [model]="contextMenuItems"></p-contextMenu>
